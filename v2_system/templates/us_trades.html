{% extends "base.html" %}

{% block title %}美股交易记录 - V2期权监控数据库{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-flag-usa"></i> 美股期权交易记录
            <span class="badge bg-info ms-2">US Market</span>
        </h1>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <nav aria-label="市场切换">
            <ul class="nav nav-pills">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('trades', market='HK') }}">
                        <i class="bi bi-flag"></i> 港股交易
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('trades', market='US') }}">
                        <i class="bi bi-flag-usa"></i> 美股交易
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- 搜索过滤器 -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="bi bi-funnel"></i> 搜索过滤
        </h6>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('trades', market='US') }}">
            <input type="hidden" name="per_page" value="{{ pagination.per_page if pagination and pagination.per_page else 50 }}">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="stock_code" class="form-label">股票代码</label>
                    <input type="text" class="form-control" id="stock_code" name="stock_code" 
                           value="{{ filters.stock_code }}" placeholder="如: US.AAPL">
                </div>
                <div class="col-md-3">
                    <label for="option_code" class="form-label">期权代码</label>
                    <input type="text" class="form-control" id="option_code" name="option_code" 
                           value="{{ filters.option_code }}" placeholder="期权代码">
                </div>
                <div class="col-md-2">
                    <label for="date_from" class="form-label">开始日期</label>
                    <input type="date" class="form-control" id="date_from" name="date_from" 
                           value="{{ filters.date_from }}">
                </div>
                <div class="col-md-2">
                    <label for="date_to" class="form-label">结束日期</label>
                    <input type="date" class="form-control" id="date_to" name="date_to" 
                           value="{{ filters.date_to }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- 交易记录表格 -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th>时间</th>
                        <th>股票</th>
                        <th>期权代码</th>
                        <th>类型</th>
                        <th>行权价</th>
                        <th>价格(美元)</th>
                        <th>成交量</th>
                        <th>成交额(美元)</th>
                        <th>涨跌幅</th>
                        <th>到期日</th>
                        <th>持仓</th>
                        <th>持仓变化量</th>
                        <th>净持仓</th>
                        <th>净持仓变化</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in trades %}
                    <tr>
                        <td>
                            <small>{{ trade.formatted_time or '-' }}</small>
                        </td>
                        <td>
                            <div>
                                <span class="badge bg-info">{{ trade.stock_code }}</span>
                                <br>
                                <small class="text-muted">{{ trade.stock_name or '-' }}</small>
                            </div>
                        </td>
                        <td>
                            <code class="text-primary">{{ trade.option_code }}</code>
                        </td>
                        <td>
                            {% if trade.option_type == 'Call' %}
                                <span class="badge bg-success">Call</span>
                            {% elif trade.option_type == 'Put' %}
                                <span class="badge bg-danger">Put</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ trade.option_type or '-' }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if trade.strike_price %}
                                ${{ "%.2f"|format(trade.strike_price) }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if trade.price %}
                                <span class="fw-bold">${{ "%.3f"|format(trade.price) }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="text-info fw-bold">{{ "{:,}".format(trade.volume or 0) }}</span>
                        </td>
                        <td>
                            {% if trade.turnover %}
                                <span class="text-success fw-bold">${{ "{:,.0f}".format(trade.turnover) }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if trade.change_rate %}
                                {% if trade.change_rate > 0 %}
                                    <span class="text-success">+{{ "%.2f"|format(trade.change_rate * 100) }}%</span>
                                {% elif trade.change_rate < 0 %}
                                    <span class="text-danger">{{ "%.2f"|format(trade.change_rate * 100) }}%</span>
                                {% else %}
                                    <span class="text-muted">0.00%</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if trade.expiry_date %}
                                <small>{{ trade.expiry_date }}</small>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if trade.option_open_interest %}
                                {{ "{:,}".format(trade.option_open_interest) }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set oi_diff = trade.open_interest_diff|int if trade.open_interest_diff else 0 %}
                            {% if oi_diff > 0 %}
                                <span class="text-success">+{{ "{:,}".format(oi_diff) }}</span>
                            {% elif oi_diff < 0 %}
                                <span class="text-danger">{{ "{:,}".format(oi_diff) }}</span>
                            {% else %}
                                <span class="text-muted">0</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if trade.option_net_open_interest %}
                                {{ "{:,}".format(trade.option_net_open_interest) }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set net_oi_diff = trade.option_net_open_interest_diff|int if trade.option_net_open_interest_diff else 0 %}
                            {% if net_oi_diff > 0 %}
                                <span class="text-success">+{{ "{:,}".format(net_oi_diff) }}</span>
                            {% elif net_oi_diff < 0 %}
                                <span class="text-danger">{{ "{:,}".format(net_oi_diff) }}</span>
                            {% else %}
                                <span class="text-muted">0</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="13" class="text-center text-muted py-4">
                            <i class="bi bi-inbox"></i> 暂无美股期权交易记录
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 分页 -->
{% if pagination and pagination.pages > 1 %}
<nav aria-label="交易记录分页" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('trades', market='US', page=pagination.prev_num, 
                    per_page=pagination.per_page,
                    stock_code=filters.stock_code, option_code=filters.option_code, 
                    date_from=filters.date_from, date_to=filters.date_to) }}">
                    <i class="bi bi-chevron-left"></i> 上一页
                </a>
            </li>
        {% endif %}
        
        {% for page_num in range(1, pagination.pages + 1) %}
            {% if page_num == pagination.page %}
                <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                </li>
            {% elif page_num <= 3 or page_num > pagination.pages - 3 or (page_num >= pagination.page - 1 and page_num <= pagination.page + 1) %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('trades', market='US', page=page_num, 
                        per_page=pagination.per_page,
                        stock_code=filters.stock_code, option_code=filters.option_code, 
                        date_from=filters.date_from, date_to=filters.date_to) }}">
                        {{ page_num }}
                    </a>
                </li>
            {% elif page_num == 4 or page_num == pagination.pages - 3 %}
                <li class="page-item disabled">
                    <span class="page-link">...</span>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('trades', market='US', page=pagination.next_num, 
                    per_page=pagination.per_page,
                    stock_code=filters.stock_code, option_code=filters.option_code, 
                    date_from=filters.date_from, date_to=filters.date_to) }}">
                    下一页 <i class="bi bi-chevron-right"></i>
                </a>
            </li>
        {% endif %}
    </ul>
</nav>

<div class="text-center text-muted mt-2">
    <small>
        显示第 {{ (pagination.page - 1) * pagination.per_page + 1 }} - 
        {{ pagination.page * pagination.per_page if pagination.page * pagination.per_page < pagination.total else pagination.total }} 条，
        共 {{ pagination.total }} 条记录
    </small>
</div>
{% endif %}

<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>美股期权交易说明：</strong>
            <ul class="mb-0 mt-2">
                <li>价格和成交额均以美元计价</li>
                <li>交易时间为美东时间，显示时间已转换为北京时间</li>
                <li>期权代码格式遵循美股期权标准</li>
                <li>数据来源于富途API美股期权接口</li>
                <li>成交量单位为张(contracts)</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 自动刷新交易记录（每30秒）
function refreshTrades() {
    window.location.reload();
}

// 可选：启用自动刷新
// setInterval(refreshTrades, 30000);

// 清空搜索条件
function clearFilters() {
    document.getElementById('stock_code').value = '';
    document.getElementById('option_code').value = '';
    document.getElementById('date_from').value = '';
    document.getElementById('date_to').value = '';
}
</script>
{% endblock %}