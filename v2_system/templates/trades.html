{% extends "base.html" %}

{% block title %}{{ market_name }}交易记录 - V2期权监控数据库{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            {% if market == 'US' %}
                <i class="bi bi-flag-usa"></i> 美股期权交易记录
                <span class="badge bg-info ms-2">US Market</span>
            {% else %}
                <i class="bi bi-flag"></i> 港股期权交易记录
                <span class="badge bg-primary ms-2">HK Market</span>
            {% endif %}
        </h1>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <nav aria-label="市场切换">
            <ul class="nav nav-pills">
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if market == 'HK' else '' }}" href="{{ url_for('trades', market='HK') }}">
                        <i class="bi bi-flag"></i> 港股交易
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if market == 'US' else '' }}" href="{{ url_for('trades', market='US') }}">
                        <i class="bi bi-flag-usa"></i> 美股交易
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- 筛选表单 -->
<div class="filter-form">
    <form method="GET" action="{{ url_for('trades', market=market) }}">
        <div class="row">
            <div class="col-md-2 mb-3">
                <label for="stock_code" class="form-label">股票代码</label>
                <input type="text" class="form-control" id="stock_code" name="stock_code" 
                       value="{{ filters.stock_code }}" placeholder="{% if market == 'US' %}如: US.AAPL{% else %}如: HK.00700{% endif %}">
            </div>
            <div class="col-md-2 mb-3">
                <label for="option_code" class="form-label">期权代码</label>
                <input type="text" class="form-control" id="option_code" name="option_code" 
                       value="{{ filters.option_code }}" placeholder="如: HK.TCH">
            </div>
            <div class="col-md-2 mb-3">
                <label for="date_from" class="form-label">开始日期</label>
                <input type="date" class="form-control" id="date_from" name="date_from" 
                       value="{{ filters.date_from }}">
            </div>
            <div class="col-md-2 mb-3">
                <label for="date_to" class="form-label">结束日期</label>
                <input type="date" class="form-control" id="date_to" name="date_to" 
                       value="{{ filters.date_to }}">
            </div>
            <div class="col-md-2 mb-3">
                <label for="filter_zero_diff" class="form-label">过滤选项</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="filter_zero_diff" name="filter_zero_diff" 
                           value="true" {% if filters.filter_zero_diff %}checked{% endif %}>
                    <label class="form-check-label" for="filter_zero_diff">
                        <small>过滤变化量为0的期权</small>
                    </label>
                </div>
            </div>
            <div class="col-md-2 mb-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> 搜索
                    </button>
                    <a href="{{ url_for('trades', market=market) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-clockwise"></i> 重置
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- 分页信息 -->
{% if pagination.total > 0 %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="pagination-info">
        显示第 {{ (pagination.page - 1) * pagination.per_page + 1 }} - 
        {{ [pagination.page * pagination.per_page, pagination.total] | min }} 条，
        共 {{ pagination.total }} 条记录
    </div>
    <div>
        <select class="form-select form-select-sm" style="width: auto;" onchange="changePerPage(this.value)">
            <option value="25" {% if pagination.per_page == 25 %}selected{% endif %}>25条/页</option>
            <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50条/页</option>
            <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100条/页</option>
        </select>
    </div>
</div>
{% endif %}

<!-- 交易记录表格 -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th>时间</th>
                        <th>股票代码</th>
                        <th>股票名称</th>
                        <th>期权代码</th>
                        <th>类型</th>
                        <th>价格</th>
                        <th>数量(张)</th>
                        <th>变化量</th>
                        <th>成交额</th>
                        <th>持仓</th>
                        <th>持仓变化量</th>
                        <th>净持仓</th>
                        <th>净持仓变化</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in trades %}
                    <tr>
                        <td>{{ trade.formatted_time or trade.timestamp[:19] }}</td>
                        <td>
                            <span class="badge bg-primary">{{ trade.stock_code }}</span>
                        </td>
                        <td>{{ trade.stock_name or '-' }}</td>
                        <td>
                            <code>{{ trade.option_code }}</code>
                        </td>
                        <td>
                            {% if trade.option_type == 'Call' %}
                                <span class="badge bg-success">Call</span>
                            {% elif trade.option_type == 'Put' %}
                                <span class="badge bg-danger">Put</span>
                            {% else %}
                                <span class="badge bg-secondary">-</span>
                            {% endif %}
                        </td>
                        <td>{{ "%.3f"|format(trade.price or 0) }}</td>
                        <td>{{ "{:,}".format(trade.volume or 0) }}</td>
                        <td>
                            {% set volume_diff = trade.volume_diff|int if trade.volume_diff else 0 %}
                            {% if volume_diff > 0 %}
                                <span class="text-success">+{{ "{:,}".format(volume_diff) }}</span>
                            {% elif volume_diff < 0 %}
                                <span class="text-danger">{{ "{:,}".format(volume_diff) }}</span>
                            {% else %}
                                <span class="text-muted">0</span>
                            {% endif %}
                        </td>
                        <td>{{ "{:,.0f}".format(trade.turnover or 0) }}</td>
                        <td>
                            {% if trade.option_open_interest %}
                                {{ "{:,}".format(trade.option_open_interest) }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set oi_diff = trade.open_interest_diff|int if trade.open_interest_diff else 0 %}
                            {% if oi_diff > 0 %}
                                <span class="text-success">+{{ "{:,}".format(oi_diff) }}</span>
                            {% elif oi_diff < 0 %}
                                <span class="text-danger">{{ "{:,}".format(oi_diff) }}</span>
                            {% else %}
                                <span class="text-muted">0</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if trade.option_net_open_interest %}
                                {{ "{:,}".format(trade.option_net_open_interest) }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% set net_oi_diff = trade.option_net_open_interest_diff|int if trade.option_net_open_interest_diff else 0 %}
                            {% if net_oi_diff > 0 %}
                                <span class="text-success">+{{ "{:,}".format(net_oi_diff) }}</span>
                            {% elif net_oi_diff < 0 %}
                                <span class="text-danger">{{ "{:,}".format(net_oi_diff) }}</span>
                            {% else %}
                                <span class="text-muted">0</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="12" class="text-center text-muted py-4">
                            <i class="bi bi-inbox"></i> 暂无数据
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 分页导航 -->
{% if pagination.pages > 1 %}
<nav aria-label="交易记录分页" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('trades', market=market, page=pagination.prev_num, per_page=pagination.per_page, **filters) }}">
                <i class="bi bi-chevron-left"></i> 上一页
            </a>
        </li>
        {% endif %}
        
        {% set start_page = [1, pagination.page - 2] | max %}
        {% set end_page = [pagination.pages + 1, pagination.page + 3] | min %}
        {% for page_num in range(start_page, end_page) %}
        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('trades', market=market, page=page_num, per_page=pagination.per_page, **filters) }}">
                {{ page_num }}
            </a>
        </li>
        {% endfor %}
        
        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link" href="{{ url_for('trades', market=market, page=pagination.next_num, per_page=pagination.per_page, **filters) }}">
                下一页 <i class="bi bi-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function changePerPage(perPage) {
    const url = new URL(window.location);
    url.searchParams.set('per_page', perPage);
    url.searchParams.set('page', '1'); // 重置到第一页
    window.location.href = url.toString();
}

// 自动刷新数据（每60秒）
function refreshData() {
    window.location.reload();
}

// 可选：启用自动刷新
// setInterval(refreshData, 60000);
</script>
{% endblock %}